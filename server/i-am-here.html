<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset=utf-8>
  <link rel="icon" type="image/png" href="./ic_launcher-web.png" />
  <title>iTracker App</title>

  <!-- OpenStreetMap + Leaflet.js -->
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
  <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="css/bootstrap.min.css" />

</head>

<body>

  <a href="https://github.com/brenohq/iTracker"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/652c5b9acfaddf3a9c326fa6bde407b87f7be0f4/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6f72616e67655f6666373630302e706e67"
        alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"></a>

  <div class="container">

    <div class="row">
      <h1 class="text-center">iTracker App</h1>
      <h2 class="text-center"><a href="https://github.com/brenohq/iTracker" target="_blank">Repositório no Github</a></h5>
      <h3 class="text-center"><a href="https://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> + <a href="http://leafletjs.com/" target="_blank">Leaflet.js</a></h3>
      <h2 class="text-center">Estive aqui em <span id="date">…</span></h2>
      <p class="text-center">(Última posição com bateria, sinal gps e internet.)</p>
    </div>

    <div class="row">
      <div class="col-md-2 col-md-offset-2">
        <div id="openstreetmap" style="width: 800px; height: 600px">
          <div id="interlude" style="text-align: center; line-height: 600px; font-weight: bold; border: 1px dotted grey; background-color: #eee;">
            Mapa indisponível.
          </div>
        </div>

        <script>
          var osmap, osmarker;
          var dte, lat, lon, utc;

          function createOSMap() {
            osmap = L.map('openstreetmap').setView([lat, lon], 12);

            L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(osmap);

            // Cria um marcador de lat e lon.
            osmarker = L.marker([lat, lon]);

            // Adiciona o marcador no mapa.
            osmarker
              .addTo(osmap)
              .bindPopup("<p>Coordenadas GPS: </p><p>" + lat + ", " + lon + "</p>");
          }

          // Atualiza e centraliza o mapa no marcador osmarker
          function updateOSMap() {
            osmarker.setLatLng([lat, lon]);
            osmarker.bindPopup("<p>Coordenadas: </p><p>" + lat + ", " + lon + "</p>");
            osmap.panTo([lat, lon]);
          }

          function doRefresh() {
            var xhr;
            try {
              xhr = new XMLHttpRequest();
            } catch (e) {
              xhr = false;
            }

            xhr.onreadystatechange = function() {
              if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                  var param = xhr.responseText.split('_');
                  dte = param[0];
                  lat = param[1];
                  lon = param[2];
                  utc = param[3];
                  if (dte && lat && lon) {
                    if (!osmap) {
                      createOSMap();
                    } else {
                      updateOSMap();
                    }
                    if (utc) {
                      utc_dte = new Date(parseInt(utc));
                      document.querySelector("#date").innerHTML = utc_dte.toLocaleString();
                    } else {
                      document.querySelector("#date").innerHTML = dte + " (Hora do Servidor)";
                    }
                  }
                }
              }
            };
            xhr.open("GET", "i-am-here-position.php?" + Math.random(), true);
            xhr.send(null);
            setTimeout('doRefresh()', 30000);
          }
          doRefresh();
        </script>
      </div>
    </div>
  </div>
</body>
